<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>深入Spring源码 - 初始化过程 - Even - A super concise theme for Hugo</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Weizhe Huang" /><meta name="description" content="初始化ApplicationContext有多种方式，比如如果配置了XML文件，则可以通过如下方式： 1 ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&amp;#34;application.xml&amp;#34;); 如果是利用注解注入，则可以如" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.64.0 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/spring/%E6%B7%B1%E5%85%A5spring%E6%BA%90%E7%A0%81-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="深入Spring源码 - 初始化过程" />
<meta property="og:description" content="初始化ApplicationContext有多种方式，比如如果配置了XML文件，则可以通过如下方式： 1 ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&#34;application.xml&#34;); 如果是利用注解注入，则可以如" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/spring/%E6%B7%B1%E5%85%A5spring%E6%BA%90%E7%A0%81-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B/" />
<meta property="article:published_time" content="2020-05-31T16:11:40+08:00" />
<meta property="article:modified_time" content="2020-05-31T16:11:40+08:00" />
<meta itemprop="name" content="深入Spring源码 - 初始化过程">
<meta itemprop="description" content="初始化ApplicationContext有多种方式，比如如果配置了XML文件，则可以通过如下方式： 1 ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&#34;application.xml&#34;); 如果是利用注解注入，则可以如">
<meta itemprop="datePublished" content="2020-05-31T16:11:40&#43;08:00" />
<meta itemprop="dateModified" content="2020-05-31T16:11:40&#43;08:00" />
<meta itemprop="wordCount" content="7113">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="深入Spring源码 - 初始化过程"/>
<meta name="twitter:description" content="初始化ApplicationContext有多种方式，比如如果配置了XML文件，则可以通过如下方式： 1 ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&#34;application.xml&#34;); 如果是利用注解注入，则可以如"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">深入Spring源码 - 初始化过程</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-05-31 </span>
        <div class="post-category">
            <a href="/categories/spring/"> Spring </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#annotationconfigapplicationcontext的初始化">AnnotationConfigApplicationContext的初始化</a>
      <ul>
        <li><a href="#构造方法">构造方法</a></li>
        <li><a href="#annotatedbeandefinitionreader的初始化">AnnotatedBeanDefinitionReader的初始化</a></li>
        <li><a href="#classpathbeandefinitionscanner的初始化">ClassPathBeanDefinitionScanner的初始化</a></li>
      </ul>
    </li>
    <li><a href="#register方法">register方法</a></li>
    <li><a href="#refresh方法">refresh方法</a>
      <ul>
        <li><a href="#preparerefresh">prepareRefresh</a></li>
        <li><a href="#obtainfreshbeanfactory">obtainFreshBeanFactory</a></li>
        <li><a href="#preparebeanfactory">prepareBeanFactory</a></li>
        <li><a href="#postprocessbeanfactory">postProcessBeanFactory</a></li>
        <li><a href="#invokebeanfactorypostprocessors">invokeBeanFactoryPostProcessors</a></li>
        <li><a href="#registerbeanpostprocessors">registerBeanPostProcessors</a></li>
        <li><a href="#initmessagesource">initMessageSource</a></li>
        <li><a href="#initapplicationeventmulticaster">initApplicationEventMulticaster</a></li>
        <li><a href="#onrefresh">onRefresh</a></li>
        <li><a href="#registerlisteners">registerListeners</a></li>
        <li><a href="#finishbeanfactoryinitialization">finishBeanFactoryInitialization</a></li>
        <li><a href="#finishrefresh">finishRefresh</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>初始化ApplicationContext有多种方式，比如如果配置了XML文件，则可以通过如下方式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">&#34;application.xml&#34;</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>如果是利用注解注入，则可以如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">AnnotationConfigApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="n">ac</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">AppConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
<span class="n">ac</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>或者直接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">AnnotationConfigApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="n">AppConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>这些ApplicationContext的不同实现类的核心功能基本一致。</p>
<p>以ClassPathXmlApplicationContext为例，几层调用后来到下面的地方：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">ClassPathXmlApplicationContext</span><span class="o">(</span>
      <span class="n">String</span><span class="o">[</span><span class="o">]</span> <span class="n">configLocations</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">refresh</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">ApplicationContext</span> <span class="n">parent</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">BeansException</span> <span class="o">{</span>

   <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">)</span><span class="o">;</span>
   <span class="n">setConfigLocations</span><span class="o">(</span><span class="n">configLocations</span><span class="o">)</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">refresh</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">refresh</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>会调用refresh方法。而这个方法是顶层抽象类AbstractApplicationContext中实现的方法，与上面初始化AnnotationConfigApplicationContext后调用的那个refresh方法是同一个方法。因此，只需要搞清楚AnnotationConfigApplicationContext的初始化过程，就可以搞清楚ApplicationContext初始化的全部核心逻辑。</p>
<h2 id="annotationconfigapplicationcontext的初始化"><strong>AnnotationConfigApplicationContext的初始化</strong></h2>
<h3 id="构造方法"><strong>构造方法</strong></h3>
<p>该类有四种构造方法。</p>
<p>第一种：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="k">this</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathBeanDefinitionScanner</span><span class="o">(</span><span class="k">this</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>第二种：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="kd">super</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="k">this</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathBeanDefinitionScanner</span><span class="o">(</span><span class="k">this</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>第三种：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">.</span><span class="o">.</span><span class="o">.</span> <span class="n">componentClasses</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="n">register</span><span class="o">(</span><span class="n">componentClasses</span><span class="o">)</span><span class="o">;</span>
   <span class="n">refresh</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>第四种：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="o">.</span><span class="o">.</span> <span class="n">basePackages</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="n">scan</span><span class="o">(</span><span class="n">basePackages</span><span class="o">)</span><span class="o">;</span>
   <span class="n">refresh</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>由构造方法可知，下面两种初始化方式是等价的，对应了第一种和第三种：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">AnnotationConfigApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="n">ac</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">AppConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
<span class="n">ac</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">AnnotationConfigApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="n">AppConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>显然，第二种也是等价的，只不过传入了一个beanFactory，在父类中完成字段的赋值。如果没有传入这个对象，那么在执行父类构造方法时就会设置一个默认值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">GenericApplicationContext</span><span class="o">(</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultListableBeanFactory</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="nf">GenericApplicationContext</span><span class="o">(</span><span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="s">&#34;BeanFactory must not be null&#34;</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个对象有什么用，会在后面分析。</p>
<p>第四种看起来有所不同，因为它调用了一个scan方法，这个方法实际上调用了AnnotationConfigApplicationContext类对象scanner的scan方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationConfigApplicationContext</span> <span class="kd">extends</span> <span class="n">GenericApplicationContext</span> <span class="kd">implements</span> <span class="n">AnnotationConfigRegistry</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="n">AnnotatedBeanDefinitionReader</span> <span class="n">reader</span><span class="o">;</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="n">ClassPathBeanDefinitionScanner</span> <span class="n">scanner</span><span class="o">;</span>
  
  
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
    
    
    
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">scan</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="o">.</span><span class="o">.</span> <span class="n">basePackages</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">Assert</span><span class="o">.</span><span class="na">notEmpty</span><span class="o">(</span><span class="n">basePackages</span><span class="o">,</span> <span class="s">&#34;At least one base package must be specified&#34;</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">scanner</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="n">basePackages</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在不需要深入源码的情况下其实可以看出，这种方式与其他三种有所差别。因为其他三种只是实例化了scanner对象，并没有调用它任何方法。register和refresh方法也不会调用到它的任何方法。这就提示我们，除非用第四种构造方法来完成初始化，否则这个scanner对象不会参与到初始化过程中。这个scan方法是一个public方法，实际上是提供给开发人员使用的，用来手动完成扫描。</p>
<h3 id="annotatedbeandefinitionreader的初始化"><strong>AnnotatedBeanDefinitionReader的初始化</strong></h3>
<p>该类的构造方法会调用到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="n">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="s">&#34;BeanDefinitionRegistry must not be null&#34;</span><span class="o">)</span><span class="o">;</span>
   <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="s">&#34;Environment must not be null&#34;</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">registry</span> <span class="o">=</span> <span class="n">registry</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConditionEvaluator</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">environment</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span><span class="o">;</span>
   <span class="n">AnnotationConfigUtils</span><span class="o">.</span><span class="na">registerAnnotationConfigProcessors</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>registry对象就是AnnotationConfigApplicationContext对象本身。AnnotationConfigApplicationContext类的父类既继承了AbstractApplicationContext类，又实现了BeanDefinitionRegistry接口。</p>
<p>核心逻辑在registerAnnotationConfigProcessors方法中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAnnotationConfigProcessors</span><span class="o">(</span><span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">registerAnnotationConfigProcessors</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">static</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="nf">registerAnnotationConfigProcessors</span><span class="o">(</span>
      <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Object</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>

   <span class="c1">// 1.获取beanFactory对象。
</span><span class="c1"></span>   <span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">unwrapDefaultListableBeanFactory</span><span class="o">(</span><span class="n">registry</span><span class="o">)</span><span class="o">;</span>
  
   <span class="c1">// 2.给beanFactory设置dependencyComparator和autowireCandidateResolver。
</span><span class="c1"></span>   <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getDependencyComparator</span><span class="o">(</span><span class="o">)</span> <span class="k">instanceof</span> <span class="n">AnnotationAwareOrderComparator</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">beanFactory</span><span class="o">.</span><span class="na">setDependencyComparator</span><span class="o">(</span><span class="n">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getAutowireCandidateResolver</span><span class="o">(</span><span class="o">)</span> <span class="k">instanceof</span> <span class="n">ContextAnnotationAutowireCandidateResolver</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">beanFactory</span><span class="o">.</span><span class="na">setAutowireCandidateResolver</span><span class="o">(</span><span class="k">new</span> <span class="n">ContextAnnotationAutowireCandidateResolver</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// 3.实例化多个BeanDefinition并放入beanDefs集合中。
</span><span class="c1"></span>   <span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">beanDefs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">8</span><span class="o">)</span><span class="o">;</span>

   <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootBeanDefinition</span><span class="o">(</span><span class="n">ConfigurationClassPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
      <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">)</span><span class="o">;</span>
      <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="n">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootBeanDefinition</span><span class="o">(</span><span class="n">AutowiredAnnotationBeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
      <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">)</span><span class="o">;</span>
      <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="n">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="c1">// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.
</span><span class="c1"></span>   <span class="k">if</span> <span class="o">(</span><span class="n">jsr250Present</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootBeanDefinition</span><span class="o">(</span><span class="n">CommonAnnotationBeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
      <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">)</span><span class="o">;</span>
      <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="n">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="c1">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.
</span><span class="c1"></span>   <span class="k">if</span> <span class="o">(</span><span class="n">jpaPresent</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootBeanDefinition</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">def</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="n">ClassUtils</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="o">,</span>
               <span class="n">AnnotationConfigUtils</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
               <span class="s">&#34;Cannot load optional framework class: &#34;</span> <span class="o">+</span> <span class="n">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="o">,</span> <span class="n">ex</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">)</span><span class="o">;</span>
      <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="n">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootBeanDefinition</span><span class="o">(</span><span class="n">EventListenerMethodProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
      <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">)</span><span class="o">;</span>
      <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="n">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootBeanDefinition</span><span class="o">(</span><span class="n">DefaultEventListenerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
      <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">)</span><span class="o">;</span>
      <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="n">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="n">beanDefs</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>registerAnnotationConfigProcessors方法的核心逻辑主要分三步。</p>
<p>第一步是获取之前的那个beanFactory对象。</p>
<p>第二步给beanFactory设置dependencyComparator和autowireCandidateResolver。这两个对象的作用之后遇到再做分析。</p>
<p>第三步是实例化多个BeanDefinition并放入beanDefs集合中。BeanDefinition是Spring的基本概念。它封装了每一个将要被实例化的Bean的描述信息。BeanDefinition这个类会在其他文章中详细分析。下面会用bd来代替BeanDefinition。</p>
<p>最关键的地方就是这里实例化出来的几个bd。以第一个为例（后面几个的过程与此相同）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootBeanDefinition</span><span class="o">(</span><span class="n">ConfigurationClassPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
   <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">)</span><span class="o">;</span>
   <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="n">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>containsBeanDefinition方法用来判断registry（即AnnotationConfigApplicationContext对象）中有没有某个bd。registry内部用一个Map来维护bd：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">BeanDefinition</span><span class="o">&gt;</span> <span class="n">beanDefinitionMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">256</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>key表示bd的名字，value表示bd对象。</p>
<p>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME就是bd的名字：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="o">=</span>
      <span class="s">&#34;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&#34;</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>如果不存在，就实例化一个RootBeanDefinition，参数为ConfigurationClassPostProcessor.class对象。RootBeanDefinition是BeanDefinition的一个实现类。setSource就是给RootBeanDefinition的一个字段source赋值。</p>
<p>然后调用registerPostProcessor方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="n">BeanDefinitionHolder</span> <span class="nf">registerPostProcessor</span><span class="o">(</span>
      <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="n">RootBeanDefinition</span> <span class="n">definition</span><span class="o">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>

   <span class="n">definition</span><span class="o">.</span><span class="na">setRole</span><span class="o">(</span><span class="n">BeanDefinition</span><span class="o">.</span><span class="na">ROLE_INFRASTRUCTURE</span><span class="o">)</span><span class="o">;</span>
   <span class="n">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">definition</span><span class="o">)</span><span class="o">;</span>
   <span class="k">return</span> <span class="k">new</span> <span class="n">BeanDefinitionHolder</span><span class="o">(</span><span class="n">definition</span><span class="o">,</span> <span class="n">beanName</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>registerBeanDefinition方法的核心逻辑就是把这个bd放入beanDefinitionMap中维护。返回的结果是一个BeanDefinitionHolder对象，其实就是把bd又封装了一下。返回后放入了beanDefs集合中。</p>
<p>这里最关键的问题其实是这几个bd有什么用。</p>
<p>这里先罗列这几个类的名称：</p>
<blockquote>
<p>ConfigurationClassPostProcessor</p>
<p>AutowiredAnnotationBeanPostProcessor</p>
<p>CommonAnnotationBeanPostProcessor</p>
<p>PersistenceAnnotationBeanPostProcessor</p>
<p>EventListenerMethodProcessor</p>
<p>DefaultEventListenerFactory</p>
</blockquote>
<p>这些类的用处非常大，可以说涵盖了Spring初始化的核心逻辑。但此处暂时不讨论它们的作用，仅仅需要记住，其中有些类实现了BeanPostProcessor接口或者BeanFactoryPostProcessor接口，前者会在bean的实例化过程中产生作用，后者会在bd产生后、bean实例化之前发生作用。</p>
<p>将这些bd注册完后，将它们放入集合中返回（其实初始化过程中外部没有用到这个集合）。AnnotatedBeanDefinitionReader的初始化完毕。</p>
<h3 id="classpathbeandefinitionscanner的初始化"><strong>ClassPathBeanDefinitionScanner的初始化</strong></h3>
<p>几层调用后来到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">ClassPathBeanDefinitionScanner</span><span class="o">(</span><span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">useDefaultFilters</span><span class="o">,</span>
      <span class="n">Environment</span> <span class="n">environment</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">)</span> <span class="o">{</span>

   <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="s">&#34;BeanDefinitionRegistry must not be null&#34;</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">registry</span> <span class="o">=</span> <span class="n">registry</span><span class="o">;</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">useDefaultFilters</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">registerDefaultFilters</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="n">setEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">)</span><span class="o">;</span>
   <span class="n">setResourceLoader</span><span class="o">(</span><span class="n">resourceLoader</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在registerDefaultFilters方法中，只需要记住这一步：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">this</span><span class="o">.</span><span class="na">includeFilters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">AnnotationTypeFilter</span><span class="o">(</span><span class="n">Component</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>在includeFilters字段中添加了一个过滤器。之后在做scan操作的时候，会用到includeFilters中的过滤器。</p>
<p>scanner对象初始化完成后，整个AnnotationConfigApplicationContext无参构造方法就结束了。</p>
<h2 id="register方法"><strong>register方法</strong></h2>
<p>得到AnnotationConfigApplicationContext对象后，调用其register方法注册一个配置类：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">.</span><span class="o">.</span><span class="o">.</span> <span class="n">componentClasses</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">Assert</span><span class="o">.</span><span class="na">notEmpty</span><span class="o">(</span><span class="n">componentClasses</span><span class="o">,</span> <span class="s">&#34;At least one component class must be specified&#34;</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">componentClasses</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">.</span><span class="o">.</span><span class="o">.</span> <span class="n">componentClasses</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span> <span class="n">componentClass</span> <span class="o">:</span> <span class="n">componentClasses</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">registerBean</span><span class="o">(</span><span class="n">componentClass</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBean</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span> <span class="n">beanClass</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">doRegisterBean</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">doRegisterBean</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
      <span class="nd">@Nullable</span> <span class="n">Class</span><span class="o">&lt;</span><span class="o">?</span> <span class="kd">extends</span> <span class="n">Annotation</span><span class="o">&gt;</span><span class="o">[</span><span class="o">]</span> <span class="n">qualifiers</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">supplier</span><span class="o">,</span>
      <span class="nd">@Nullable</span> <span class="n">BeanDefinitionCustomizer</span><span class="o">[</span><span class="o">]</span> <span class="n">customizers</span><span class="o">)</span> <span class="o">{</span>

   <span class="c1">// 实例化一个AnnotatedGenericBeanDefinition对象。
</span><span class="c1"></span>   <span class="n">AnnotatedGenericBeanDefinition</span> <span class="n">abd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotatedGenericBeanDefinition</span><span class="o">(</span><span class="n">beanClass</span><span class="o">)</span><span class="o">;</span>
  
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

   <span class="c1">// 将bd对象封装成BeanDefinitionHolder对象。
</span><span class="c1"></span>   <span class="n">BeanDefinitionHolder</span> <span class="n">definitionHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanDefinitionHolder</span><span class="o">(</span><span class="n">abd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">)</span><span class="o">;</span>
   <span class="n">definitionHolder</span> <span class="o">=</span> <span class="n">AnnotationConfigUtils</span><span class="o">.</span><span class="na">applyScopedProxyMode</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">,</span> <span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">)</span><span class="o">;</span>
   <span class="c1">// 注册bd。
</span><span class="c1"></span>   <span class="n">BeanDefinitionReaderUtils</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>核心逻辑封装在doRegisterBean方法中。</p>
<p>首先实例化一个AnnotatedGenericBeanDefinition，它也是BeanDefinition的一个实现类。中间经过一些简单的赋值等操作，最后对bd进行注册。</p>
<p>也就是说，register方法的核心逻辑就是对注册类生成bd，然后注册到beanDefinitionMap中。</p>
<h2 id="refresh方法"><strong>refresh方法</strong></h2>
<p>前面的初始化过程，基本上就是构造了几个bd，然后注册到了beanDefinitionMap中。而refresh方法可以说才是Spring初始化过程的精髓。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="o">,</span> <span class="n">IllegalStateException</span> <span class="o">{</span>
   <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">startupShutdownMonitor</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Prepare this context for refreshing.
</span><span class="c1"></span>      <span class="n">prepareRefresh</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

      <span class="c1">// Tell the subclass to refresh the internal bean factory.
</span><span class="c1"></span>      <span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

      <span class="c1">// Prepare the bean factory for use in this context.
</span><span class="c1"></span>      <span class="n">prepareBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>

      <span class="k">try</span> <span class="o">{</span>
         <span class="c1">// Allows post-processing of the bean factory in context subclasses.
</span><span class="c1"></span>         <span class="n">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>

         <span class="c1">// Invoke factory processors registered as beans in the context.
</span><span class="c1"></span>         <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>

         <span class="c1">// Register bean processors that intercept bean creation.
</span><span class="c1"></span>         <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>

         <span class="c1">// Initialize message source for this context.
</span><span class="c1"></span>         <span class="n">initMessageSource</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

         <span class="c1">// Initialize event multicaster for this context.
</span><span class="c1"></span>         <span class="n">initApplicationEventMulticaster</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

         <span class="c1">// Initialize other special beans in specific context subclasses.
</span><span class="c1"></span>         <span class="n">onRefresh</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

         <span class="c1">// Check for listener beans and register them.
</span><span class="c1"></span>         <span class="n">registerListeners</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

         <span class="c1">// Instantiate all remaining (non-lazy-init) singletons.
</span><span class="c1"></span>         <span class="n">finishBeanFactoryInitialization</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>

         <span class="c1">// Last step: publish corresponding event.
</span><span class="c1"></span>         <span class="n">finishRefresh</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="k">catch</span> <span class="o">(</span><span class="n">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
          
      <span class="o">}</span>

      <span class="k">finally</span> <span class="o">{</span>

        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
          
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面注释是源码自带的，由此可以看出官方十分重视这个流程，给每一步都添加了注释。下面逐个分析。</p>
<h3 id="preparerefresh"><strong>prepareRefresh</strong></h3>
<p>准备refresh操作的上下文环境。此方法可以认为没有做任何事，留给以后扩展使用。</p>
<h3 id="obtainfreshbeanfactory"><strong>obtainFreshBeanFactory</strong></h3>
<p>可以认为就是获得了之前那个beanFactory对象。</p>
<h3 id="preparebeanfactory"><strong>prepareBeanFactory</strong></h3>
<p>这个方法是对beanFactory做一些准备工作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareBeanFactory</span><span class="o">(</span><span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
  
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

   <span class="c1">// Configure the bean factory with context callbacks.
</span><span class="c1"></span>   <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="n">ApplicationContextAwareProcessor</span><span class="o">(</span><span class="k">this</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="n">EnvironmentAware</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="n">EmbeddedValueResolverAware</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="n">ResourceLoaderAware</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="n">ApplicationEventPublisherAware</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="n">MessageSourceAware</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="n">ApplicationContextAware</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">;</span>

  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
    
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>主要就是调用了beanFactory的几个方法完成一些初始化工作。其中ignoreDependencyInterface方法的作用是在自动装配的过程中忽略掉给定的这些接口实现类。也就是说，如果你定义的类中有字段的类型是这些接口的实现类，Spring会在某个阶段专门给这些字段赋值，而不是在自动装配的时候赋值。至于这些接口有什么用，本文不展开讨论。</p>
<h3 id="postprocessbeanfactory"><strong>postProcessBeanFactory</strong></h3>
<p>这个方法没有实现，留给以后做扩展。</p>
<h3 id="invokebeanfactorypostprocessors"><strong>invokeBeanFactoryPostProcessors</strong></h3>
<p>从名字可以看出，这个方法就是去调用所有之前注册的实现了BeanFactoryPostProcessor接口的类的相关方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">PostProcessorRegistrationDelegate</span><span class="o">.</span><span class="na">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">getBeanFactoryPostProcessors</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>

   <span class="c1">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime
</span><span class="c1"></span>   <span class="c1">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)
</span><span class="c1"></span>   <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getTempClassLoader</span><span class="o">(</span><span class="o">)</span> <span class="o">=</span><span class="o">=</span> <span class="kc">null</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">containsBean</span><span class="o">(</span><span class="n">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="n">LoadTimeWeaverAwareProcessor</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">setTempClassLoader</span><span class="o">(</span><span class="k">new</span> <span class="n">ContextTypeMatchClassLoader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanClassLoader</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>invokeBeanFactoryPostProcessors方法的第二个参数表示开发人员手动添加的BeanFactoryPostProcessor。这里手动添加的意思是调用addBeanFactoryPostProcessor方法添加，不包括通过注解注册的。</p>
<p>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors方法是整个Spring初始化流程中最重要的方法之一：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeBeanFactoryPostProcessors</span><span class="o">(</span>
      <span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">beanFactoryPostProcessors</span><span class="o">)</span> <span class="o">{</span>

   <span class="c1">// 1.创建一个集合，用来存放已经处理过的类，以免重复处理。
</span><span class="c1"></span>   <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">processedBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="n">BeanDefinitionRegistry</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="o">(</span><span class="n">BeanDefinitionRegistry</span><span class="o">)</span> <span class="n">beanFactory</span><span class="o">;</span>
      <span class="c1">// 2.创建两个列表，用来存放不同类型的后置处理器。
</span><span class="c1"></span>      <span class="n">List</span><span class="o">&lt;</span><span class="n">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">regularPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="n">List</span><span class="o">&lt;</span><span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">&gt;</span> <span class="n">registryProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

      <span class="c1">// 3.遍历的就是手动传入的后置处理器。
</span><span class="c1"></span>      <span class="k">for</span> <span class="o">(</span><span class="n">BeanFactoryPostProcessor</span> <span class="n">postProcessor</span> <span class="o">:</span> <span class="n">beanFactoryPostProcessors</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// 如果该后置处理器还实现了BeanDefinitionRegistryPostProcessor接口，那么就调用其postProcessBeanDefinitionRegistry方法并将其放入registryProcessors列表中。
</span><span class="c1"></span>         <span class="k">if</span> <span class="o">(</span><span class="n">postProcessor</span> <span class="k">instanceof</span> <span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">BeanDefinitionRegistryPostProcessor</span> <span class="n">registryProcessor</span> <span class="o">=</span>
                  <span class="o">(</span><span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">)</span> <span class="n">postProcessor</span><span class="o">;</span>
            <span class="n">registryProcessor</span><span class="o">.</span><span class="na">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="n">registry</span><span class="o">)</span><span class="o">;</span>
            <span class="n">registryProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registryProcessor</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 否则放入regularPostProcessors列表中。
</span><span class="c1"></span>            <span class="n">regularPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">postProcessor</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span>

      <span class="c1">// 4.构造一个列表，用来存放注册好的BeanDefinitionRegistryPostProcessor。
</span><span class="c1"></span>      <span class="n">List</span><span class="o">&lt;</span><span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">&gt;</span> <span class="n">currentRegistryProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

      <span class="c1">// 5.将之前注册好的BeanDefinitionRegistryPostProcessor取出来。
</span><span class="c1"></span>      <span class="n">String</span><span class="o">[</span><span class="o">]</span> <span class="n">postProcessorNames</span> <span class="o">=</span>
            <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// 只处理那些实现了PriorityOrdered接口的，放入currentRegistryProcessors中。
</span><span class="c1"></span>         <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="n">PriorityOrdered</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
            <span class="n">processedBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
      <span class="n">registryProcessors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">)</span><span class="o">;</span>
      <span class="n">invokeBeanDefinitionRegistryPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">registry</span><span class="o">)</span><span class="o">;</span>
      <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">clear</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

      <span class="c1">// 6.再次将之前注册好的BeanDefinitionRegistryPostProcessor取出来。
</span><span class="c1"></span>      <span class="n">postProcessorNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// 只处理那些之前没有处理过并且实现了Ordered接口的，放入currentRegistryProcessors中。
</span><span class="c1"></span>         <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">processedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="n">Ordered</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
            <span class="n">processedBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
      <span class="n">registryProcessors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">)</span><span class="o">;</span>
      <span class="n">invokeBeanDefinitionRegistryPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">registry</span><span class="o">)</span><span class="o">;</span>
      <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">clear</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

      <span class="c1">// 7.经过前面的处理，可能又会有新的BeanDefinitionRegistryPostProcessor被注册，对这部分对象进行迭代处理。
</span><span class="c1"></span>      <span class="kt">boolean</span> <span class="n">reiterate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">while</span> <span class="o">(</span><span class="n">reiterate</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">reiterate</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
         <span class="n">postProcessorNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span><span class="o">;</span>
         <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">processedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
               <span class="n">processedBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span><span class="o">;</span>
               <span class="n">reiterate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
         <span class="o">}</span>
         <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
         <span class="n">registryProcessors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">)</span><span class="o">;</span>
         <span class="n">invokeBeanDefinitionRegistryPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">registry</span><span class="o">)</span><span class="o">;</span>
         <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">clear</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// 8.调用BeanFactoryPostProcessor接口的postProcessBeanFactory方法。
</span><span class="c1"></span>      <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">registryProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
      <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">regularPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">else</span> <span class="o">{</span>
      <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactoryPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="c1">// 9.取出之前注册好的BeanFactoryPostProcessor。
</span><span class="c1"></span>   <span class="n">String</span><span class="o">[</span><span class="o">]</span> <span class="n">postProcessorNames</span> <span class="o">=</span>
         <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="n">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span><span class="o">;</span>

   <span class="c1">// 10.构造不同的列表，将实现不同接口的对象放入对应的列表中。
</span><span class="c1"></span>   <span class="n">List</span><span class="o">&lt;</span><span class="n">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">priorityOrderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">orderedPostProcessorNames</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">nonOrderedPostProcessorNames</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">processedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// skip - already processed in first phase above
</span><span class="c1"></span>      <span class="o">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="n">PriorityOrdered</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">priorityOrderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="n">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="n">Ordered</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">orderedPostProcessorNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="n">nonOrderedPostProcessorNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// 11.调用实现了PriorityOrdered接口的对象的方法。
</span><span class="c1"></span>   <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">priorityOrderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
   <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">priorityOrderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>

   <span class="c1">// 12.调用实现了Ordered接口的对象的方法。
</span><span class="c1"></span>   <span class="n">List</span><span class="o">&lt;</span><span class="n">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">orderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">orderedPostProcessorNames</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">postProcessorName</span> <span class="o">:</span> <span class="n">orderedPostProcessorNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">orderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">postProcessorName</span><span class="o">,</span> <span class="n">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">orderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>
   <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">orderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>

   <span class="c1">// 13.调用剩下的对象的方法。
</span><span class="c1"></span>   <span class="n">List</span><span class="o">&lt;</span><span class="n">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">nonOrderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">nonOrderedPostProcessorNames</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">postProcessorName</span> <span class="o">:</span> <span class="n">nonOrderedPostProcessorNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">nonOrderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">postProcessorName</span><span class="o">,</span> <span class="n">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">nonOrderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">)</span><span class="o">;</span>

   <span class="n">beanFactory</span><span class="o">.</span><span class="na">clearMetadataCache</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>核心逻辑已在上面的代码中注释。</p>
<p>第五步中取出的就是之前注册的ConfigurationClassPostProcessor类。注意，因为之前注册的只是bd，所以这里还涉及到了bean的实例化过程。本文对bean的实例化不做分析。</p>
<p>可以看到每次得到后置处理器后都会调用invokeBeanDefinitionRegistryPostProcessors方法，方法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeBeanDefinitionRegistryPostProcessors</span><span class="o">(</span>
      <span class="n">Collection</span><span class="o">&lt;</span><span class="o">?</span> <span class="kd">extends</span> <span class="n">BeanDefinitionRegistryPostProcessor</span><span class="o">&gt;</span> <span class="n">postProcessors</span><span class="o">,</span> <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>

   <span class="k">for</span> <span class="o">(</span><span class="n">BeanDefinitionRegistryPostProcessor</span> <span class="n">postProcessor</span> <span class="o">:</span> <span class="n">postProcessors</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">postProcessor</span><span class="o">.</span><span class="na">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="n">registry</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>第五步中只有一个postProcessor，所以其实就是调用ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
   <span class="kt">int</span> <span class="n">registryId</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">registry</span><span class="o">)</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registriesPostProcessed</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">registryId</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
            <span class="s">&#34;postProcessBeanDefinitionRegistry already called on this post-processor against &#34;</span> <span class="o">+</span> <span class="n">registry</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">factoriesPostProcessed</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">registryId</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
            <span class="s">&#34;postProcessBeanFactory already called on this post-processor against &#34;</span> <span class="o">+</span> <span class="n">registry</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">this</span><span class="o">.</span><span class="na">registriesPostProcessed</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registryId</span><span class="o">)</span><span class="o">;</span>

   <span class="n">processConfigBeanDefinitions</span><span class="o">(</span><span class="n">registry</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// 创建一个列表，用来存放配置类。
</span><span class="c1"></span>   <span class="n">List</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">configCandidates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="c1">// 获取之前注册的bd的名字。
</span><span class="c1"></span>   <span class="n">String</span><span class="o">[</span><span class="o">]</span> <span class="n">candidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

   <span class="c1">// 找出配置类，放入configCandidates列表中。
</span><span class="c1"></span>   <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">candidateNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">BeanDefinition</span> <span class="n">beanDef</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">)</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">beanDef</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">ConfigurationClassUtils</span><span class="o">.</span><span class="na">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="o">)</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Bean definition has already been processed as a configuration class: &#34;</span> <span class="o">+</span> <span class="n">beanDef</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">configCandidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="n">beanName</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
  
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

   <span class="c1">// 构造一个解析器，用来解析配置类。
</span><span class="c1"></span>   <span class="n">ConfigurationClassParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConfigurationClassParser</span><span class="o">(</span>
         <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
         <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span><span class="o">,</span> <span class="n">registry</span><span class="o">)</span><span class="o">;</span>

   <span class="c1">// 对上面的configCandidates进行去重放入一个集合中。
</span><span class="c1"></span>   <span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">configCandidates</span><span class="o">)</span><span class="o">;</span>
   <span class="c1">// 构造一个集合，用来存放已经解析过的类。
</span><span class="c1"></span>   <span class="n">Set</span><span class="o">&lt;</span><span class="n">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">alreadyParsed</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="k">do</span> <span class="o">{</span>
      <span class="c1">// 对配置类进行解析。
</span><span class="c1"></span>      <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">candidates</span><span class="o">)</span><span class="o">;</span>
     
     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

      <span class="c1">// Read the model and create bean definitions based on its content
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConfigurationClassBeanDefinitionReader</span><span class="o">(</span>
               <span class="n">registry</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">sourceExtractor</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
               <span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getImportRegistry</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">// 加载配置类中提示要加载的内容。
</span><span class="c1"></span>      <span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">configClasses</span><span class="o">)</span><span class="o">;</span>
     
     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
       
   <span class="o">}</span>
   <span class="k">while</span> <span class="o">(</span><span class="o">!</span><span class="n">candidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
  
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
    
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中，如果在配置类中@ComponentScan注解，那么在parse方法中就会对这些类进行注册。如果添加了@ImportResource注解，就会在reader.loadBeanDefinitions方法中去注册对应的bd。</p>
<p>parse方法内部需要考虑的事情非常多，过程也较为复杂，会在下文详细分析。</p>
<p>总而言之，从流程上看，就是在invokeBeanFactoryPostProcessors方法中，调用了ConfigurationClassPostProcessor类的postProcessBeanDefinitionRegistry方法，对配置类进行了解析，将所有类都注册进了上下文中。</p>
<p>第五步结束后，后面的步骤也是类似的，都是对不同的后置处理器调用其方法。</p>
<h3 id="registerbeanpostprocessors"><strong>registerBeanPostProcessors</strong></h3>
<p>注册BeanPostProcessor。这些后置处理器的作用会在其他文章中分析。</p>
<h3 id="initmessagesource"><strong>initMessageSource</strong></h3>
<p>初始化MessageSource。</p>
<h3 id="initapplicationeventmulticaster"><strong>initApplicationEventMulticaster</strong></h3>
<p>初始化ApplicationEventMulticaster。</p>
<h3 id="onrefresh"><strong>onRefresh</strong></h3>
<p>空方法。给子类扩展。</p>
<h3 id="registerlisteners"><strong>registerListeners</strong></h3>
<p>将实现了ApplicationListener接口的bean添加进上下文。</p>
<h3 id="finishbeanfactoryinitialization"><strong>finishBeanFactoryInitialization</strong></h3>
<p>beanFactory初始化结束后的一些工作。</p>
<h3 id="finishrefresh"><strong>finishRefresh</strong></h3>
<p>refresh方法最后的收尾工作。</p>
<h2 id="总结"><strong>总结</strong></h2>
<p>对于AnnotationConfigApplicationContext来说，初始化过程首先会添加一些内置的后置处理器，然后将自定义的配置类注册进上下文，最后会利用内置的后置处理器中的类对配置类进行处理，进而将所有类都添加进上下文。在这个过程中refresh方法是精髓，其中的invokeBeanFactoryPostProcessors方法和registerBeanPostProcessors方法会分别对BeanFactoryPostProcessor和BeanPostProcessor进行处理。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Weizhe Huang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-05-31
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        
        <a class="next" href="/post/spring/%E6%B7%B1%E5%85%A5spring%E6%BA%90%E7%A0%81-%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/">
            <span class="next-text nav-default">深入Spring源码 - 自动注入的几种方式</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="http://localhost:1313" class="iconfont icon-twitter" title="twitter"></a>
      <a href="http://localhost:1313" class="iconfont icon-facebook" title="facebook"></a>
      <a href="http://localhost:1313" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-pocket" title="pocket"></a>
      <a href="http://localhost:1313" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
      <a href="http://localhost:1313" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="http://localhost:1313" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Weizhe Huang</span>
  </span>
</div>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]} })
</script>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>

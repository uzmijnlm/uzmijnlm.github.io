<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>深入Flink源码 - Checkpoint文件的写入流程 - Even - A super concise theme for Hugo</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Weizhe Huang" /><meta name="description" content="在开启了Flink的checkpoint机制后，每一次成功地进行checkpoint都可以在checkpoint的目录下看到一个新的检查点目" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.64.0 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/%E6%B7%B1%E5%85%A5flink%E6%BA%90%E7%A0%81-checkpoint%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="深入Flink源码 - Checkpoint文件的写入流程" />
<meta property="og:description" content="在开启了Flink的checkpoint机制后，每一次成功地进行checkpoint都可以在checkpoint的目录下看到一个新的检查点目" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/%E6%B7%B1%E5%85%A5flink%E6%BA%90%E7%A0%81-checkpoint%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/" />
<meta property="article:published_time" content="2020-03-18T15:11:40+08:00" />
<meta property="article:modified_time" content="2020-03-18T15:11:40+08:00" />
<meta itemprop="name" content="深入Flink源码 - Checkpoint文件的写入流程">
<meta itemprop="description" content="在开启了Flink的checkpoint机制后，每一次成功地进行checkpoint都可以在checkpoint的目录下看到一个新的检查点目">
<meta itemprop="datePublished" content="2020-03-18T15:11:40&#43;08:00" />
<meta itemprop="dateModified" content="2020-03-18T15:11:40&#43;08:00" />
<meta itemprop="wordCount" content="9259">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="深入Flink源码 - Checkpoint文件的写入流程"/>
<meta name="twitter:description" content="在开启了Flink的checkpoint机制后，每一次成功地进行checkpoint都可以在checkpoint的目录下看到一个新的检查点目"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">深入Flink源码 - Checkpoint文件的写入流程</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-03-18 </span>
        <div class="post-category">
            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"> 大数据 </a>
            <a href="/categories/flink/"> flink </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#task端的操作">Task端的操作</a>
      <ul>
        <li><a href="#写入状态元信息">写入状态元信息</a></li>
        <li><a href="#写入状态数据">写入状态数据</a></li>
      </ul>
    </li>
    <li><a href="#处理文件元信息">处理文件元信息</a></li>
    <li><a href="#jobmanager端的操作">JobManager端的操作</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>在开启了Flink的checkpoint机制后，每一次成功地进行checkpoint都可以在checkpoint的目录下看到一个新的检查点目录，目录下会有一个_metadata文件，还会有数个文件名为随机字符串的文件。这个_metadata文件记录了本次checkpoint状态数据的文件元信息，其他文件里记录的是实际的状态数据。</p>
<p>这里一定要注意，状态本身是有元信息的，如序列化器等信息，这部分信息本文统一称为“<strong>状态元信息</strong>”，这些状态元信息随着状态数据一起存入了状态数据文件中（即文件名为随机字符串的文件）。而_metadata中记录的是状态数据文件的文件路径、文件大小，以及每个状态在具体哪个文件的哪个位置，这部分信息本文统一称为“<strong>文件元信息</strong>”。在接下来的分析中注意区分两者。</p>
<p>本文将以OperatorState为例，分析checkpoint相关文件的写入和读取流程。KeyedState的调用链略有不同，但流程类似。</p>
<h2 id="task端的操作"><strong>Task端的操作</strong></h2>
<h3 id="写入状态元信息"><strong>写入状态元信息</strong></h3>
<p>分析每次触发checkpoint的方法调用链，最后会来到DefaultOperatorStateBackendSnapshotStrategy.snapshot方法，这个方法会启动一个异步任务，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">AsyncSnapshotCallable</span><span class="o">&lt;</span><span class="n">SnapshotResult</span><span class="o">&lt;</span><span class="n">OperatorStateHandle</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">snapshotCallable</span> <span class="o">=</span>
   <span class="k">new</span> <span class="n">AsyncSnapshotCallable</span><span class="o">&lt;</span><span class="n">SnapshotResult</span><span class="o">&lt;</span><span class="n">OperatorStateHandle</span><span class="o">&gt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span> <span class="o">{</span>

      <span class="nd">@Override</span>
      <span class="kd">protected</span> <span class="n">SnapshotResult</span><span class="o">&lt;</span><span class="n">OperatorStateHandle</span><span class="o">&gt;</span> <span class="nf">callInternal</span><span class="o">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

         <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
           
   <span class="o">}</span><span class="o">;</span>

<span class="kd">final</span> <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">SnapshotResult</span><span class="o">&lt;</span><span class="n">OperatorStateHandle</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span>
   <span class="n">snapshotCallable</span><span class="o">.</span><span class="na">toAsyncSnapshotFutureTask</span><span class="o">(</span><span class="n">closeStreamOnCancelRegistry</span><span class="o">)</span><span class="o">;</span>

<span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">asynchronousSnapshots</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>DefaultOperatorStateBackendSnapshotStrategy类有一个registeredOperatorStates字段，这个字段保存了状态数据的所有状态元信息和状态数据，如下：</p>
<p><img src="/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/Checkpoint%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/registeredOperatorStatesDeepCopies.png" alt="registeredOperatorStatesDeepCopies"></p>
<p>每个元素的value中，stateMetaInfo字段保存了其状态元信息，internalList中保存了实际的数据。这些信息会拷贝到另一个对象registeredOperatorStatesDeepCopies中。实际上这里还涉及到BroadcastState的写入，这部分内容与OperatorState几乎完全一致，本文不会对BroadcastState的相关步骤进行分析。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PartitionableListState</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">registeredOperatorStatesDeepCopies</span> <span class="o">=</span>
   <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">registeredOperatorStates</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>

<span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

<span class="k">try</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">registeredOperatorStates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PartitionableListState</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">registeredOperatorStates</span><span class="o">.</span><span class="na">entrySet</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">PartitionableListState</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span> <span class="n">listState</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
         <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!</span><span class="o">=</span> <span class="n">listState</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">listState</span> <span class="o">=</span> <span class="n">listState</span><span class="o">.</span><span class="na">deepCopy</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>
         <span class="n">registeredOperatorStatesDeepCopies</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="o">)</span><span class="o">,</span> <span class="n">listState</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>

<span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
  
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在异步任务的callInternal方法中，操作的都是registeredOperatorStatesDeepCopies对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">StateMetaInfoSnapshot</span><span class="o">&gt;</span> <span class="n">operatorMetaInfoSnapshots</span> <span class="o">=</span>
   <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">registeredOperatorStatesDeepCopies</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>

<span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PartitionableListState</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span>
   <span class="n">registeredOperatorStatesDeepCopies</span><span class="o">.</span><span class="na">entrySet</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">operatorMetaInfoSnapshots</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">getStateMetaInfo</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">snapshot</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>

<span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
  
<span class="n">DataOutputView</span> <span class="n">dov</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputViewStreamWrapper</span><span class="o">(</span><span class="n">localOut</span><span class="o">)</span><span class="o">;</span>

<span class="n">OperatorBackendSerializationProxy</span> <span class="n">backendSerializationProxy</span> <span class="o">=</span>
   <span class="k">new</span> <span class="n">OperatorBackendSerializationProxy</span><span class="o">(</span><span class="n">operatorMetaInfoSnapshots</span><span class="o">,</span> <span class="n">broadcastMetaInfoSnapshots</span><span class="o">)</span><span class="o">;</span>

<span class="n">backendSerializationProxy</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dov</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，这里是先取出了stateMetaInfo中的信息进行了写入。这部分信息包含以下内容：</p>
<p><img src="/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/Checkpoint%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/operatorMetaInfoSnapshots.png" alt="operatorMetaInfoSnapshots"></p>
<p>其中有状态的名称、类型、分配模式（options字段中记录了这个状态为UNION）、序列化器信息。</p>
<p>写入的细节如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputView</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="kd">super</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">)</span><span class="o">;</span>
   <span class="n">writeStateMetaInfoSnapshots</span><span class="o">(</span><span class="n">operatorStateMetaInfoSnapshots</span><span class="o">,</span> <span class="n">out</span><span class="o">)</span><span class="o">;</span>
   <span class="n">writeStateMetaInfoSnapshots</span><span class="o">(</span><span class="n">broadcastStateMetaInfoSnapshots</span><span class="o">,</span> <span class="n">out</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>进入到super.write方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DataOutputView</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">getVersion</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>得到版本信息，写入到接下来4个字节中。这里的out有一个字段为written，每次写入时都会对其进行递增，记录了当前一共写了多少字节。</p>
<p>进入到writeStateMetaInfoSnapshots方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeStateMetaInfoSnapshots</span><span class="o">(</span>
   <span class="n">List</span><span class="o">&lt;</span><span class="n">StateMetaInfoSnapshot</span><span class="o">&gt;</span> <span class="n">snapshots</span><span class="o">,</span>
   <span class="n">DataOutputView</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">snapshots</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="n">StateMetaInfoSnapshot</span> <span class="n">state</span> <span class="o">:</span> <span class="n">snapshots</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">StateMetaInfoSnapshotReadersWriters</span><span class="o">.</span><span class="na">getWriter</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">writeStateMetaInfoSnapshot</span><span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">out</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>先得到snapshots的大小，写入到接下来2个字节中。然后遍历snapshots。分析writeStateMetaInfoSnapshot方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeStateMetaInfoSnapshot</span><span class="o">(</span>
   <span class="nd">@Nonnull</span> <span class="n">StateMetaInfoSnapshot</span> <span class="n">snapshot</span><span class="o">,</span>
   <span class="nd">@Nonnull</span> <span class="n">DataOutputView</span> <span class="n">outputView</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">optionsMap</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="na">getOptionsImmutable</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">TypeSerializerSnapshot</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">serializerConfigSnapshotsMap</span> <span class="o">=</span>
      <span class="n">snapshot</span><span class="o">.</span><span class="na">getSerializerSnapshotsImmutable</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

   <span class="n">outputView</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">snapshot</span><span class="o">.</span><span class="na">getName</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="n">outputView</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">snapshot</span><span class="o">.</span><span class="na">getBackendStateType</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">ordinal</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="n">outputView</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">optionsMap</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">optionsMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">outputView</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
      <span class="n">outputView</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="n">outputView</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">serializerConfigSnapshotsMap</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">TypeSerializerSnapshot</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">serializerConfigSnapshotsMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="n">outputView</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>

      <span class="n">TypeSerializerSnapshotSerializationUtil</span><span class="o">.</span><span class="na">writeSerializerSnapshot</span><span class="o">(</span>
         <span class="n">outputView</span><span class="o">,</span> <span class="o">(</span><span class="n">TypeSerializerSnapshot</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="o">)</span><span class="o">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="na">getTypeSerializer</span><span class="o">(</span><span class="n">key</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个方法执行了很多写入操作，并且具体的写入内容会根据snapshot的不同而不同，这里以flink kafka offset状态为例。该snapshot对象是TupleSerializerSnapshot类。</p>
<p>其中writeUTF写入的字节长度不确定，该方法的描述是先写入2个字节，表示接下来这个字符串会占用的长度，然后将String写入。在读取时只需调用readUTF方法即可。写完name后，用4个字节记录状态类型（OperatorState或KeyedState等）。用4个字节记录options的大小，遍历options记录key和value。用4个字节记录serializerConfigSnapshotsMap的大小，这个对象内部封装的也是序列化器等信息。每次循环内部先记录key的信息，然后调用writeSerializerSnapshot方法。方法内部主要逻辑是先用4个字节记录版本信息，然后用writeUTF写入TypeSerializerSnapshot实现类的类名，用4个字节写入snapshot的版本。接着又会用4个字节写入MAGIC_NUMBER，用四个字节写snapshot的版本信息，用writeUTF写入这个snapshot对象中tupleClass字段的值，这里是flink Tuple2类的全类名。</p>
<p>由于TupleSerializerSnapshot继承了CompositeTypeSerializerSnapshot类（MapSerializerSnapshot、ListSerializerSnapshot等类都集成了这个类），所以还需要写入Tuple2内部的类的信息。先用4个字节记录MAGIC_NUMBER，用4个字节记录版本，用4个字节内部有多少个元素（比如对于Tuple2来说就是2），接着writeUTF记录snapshot的类名，用4个字节记录版本。这里的snapshot是KryoSerializerSnapshot，还需要记录下内部到底封装了什么具体的类，对于offset来说就是KafkaTopicPartition类。后面过程比较重复，不再分析。</p>
<p>总之，调用完backendSerializationProxy.write方法后，flink将序列化信息写入到了byte数组中。并且localOut对象知道当前写入的位置。</p>
<h3 id="写入状态数据"><strong>写入状态数据</strong></h3>
<p>接下来的操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">initialMapCapacity</span> <span class="o">=</span>
   <span class="n">registeredOperatorStatesDeepCopies</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span> <span class="o">+</span> <span class="n">registeredBroadcastStatesDeepCopies</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">OperatorStateHandle</span><span class="o">.</span><span class="na">StateMetaInfo</span><span class="o">&gt;</span> <span class="n">writtenStatesMetaData</span> <span class="o">=</span>
   <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">initialMapCapacity</span><span class="o">)</span><span class="o">;</span>

<span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PartitionableListState</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span>
   <span class="n">registeredOperatorStatesDeepCopies</span><span class="o">.</span><span class="na">entrySet</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>

   <span class="n">PartitionableListState</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="kt">long</span><span class="o">[</span><span class="o">]</span> <span class="n">partitionOffsets</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">localOut</span><span class="o">)</span><span class="o">;</span>
   <span class="n">OperatorStateHandle</span><span class="o">.</span><span class="na">Mode</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">getStateMetaInfo</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">getAssignmentMode</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="n">writtenStatesMetaData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span>
      <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="o">)</span><span class="o">,</span>
      <span class="k">new</span> <span class="n">OperatorStateHandle</span><span class="o">.</span><span class="na">StateMetaInfo</span><span class="o">(</span><span class="n">partitionOffsets</span><span class="o">,</span> <span class="n">mode</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>先构造了一个Map，这个Map中会存放OperatorState和BroadcastState写到文件后文件的位置和各种状态在文件中的位置等信息。</p>
<p>循环中对每一个状态进行处理。</p>
<p>下面还是以offset这个状态为例，看看value.write方法内部做了什么处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">long</span><span class="o">[</span><span class="o">]</span> <span class="nf">write</span><span class="o">(</span><span class="n">FSDataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

   <span class="kt">long</span><span class="o">[</span><span class="o">]</span> <span class="n">partitionOffsets</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="n">internalList</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">]</span><span class="o">;</span>

   <span class="n">DataOutputView</span> <span class="n">dov</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputViewStreamWrapper</span><span class="o">(</span><span class="n">out</span><span class="o">)</span><span class="o">;</span>

   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">internalList</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">;</span> <span class="o">+</span><span class="o">+</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">S</span> <span class="n">element</span> <span class="o">=</span> <span class="n">internalList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)</span><span class="o">;</span>
      <span class="n">partitionOffsets</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">getPos</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="n">getStateMetaInfo</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">getPartitionStateSerializer</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">dov</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="n">partitionOffsets</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>offset是一个ListState，内部用internalList对象存储每个TopicPartition的offset。在FlinkKafkaConsumerBase的snapshotState方法中，可以看到调用了unionOffsetStates.add方法更新每次的状态信息，就是在这里将数据放入了这个internalList对象。在这个write方法中，先根据这个list的长度，构造了一个long类型的数组。这个数组的作用就是记录internalList中每个元素在文件中的起始位置。最后这个方法会将这个数组返回。</p>
<p>接下来的循环中，就是从out对象中获取当前位置，记录在partitionOffsets数组中，并且对list中的每个元素进行序列化。序列化调用的方法就是serialize，具体的实现由实现类决定。这这里的实现类是TupleSerialize，其实现为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">,</span> <span class="n">DataOutputView</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arity</span><span class="o">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="n">i</span><span class="o">)</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">fieldSerializers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">target</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NullPointerException</span> <span class="n">npex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">NullFieldException</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">npex</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>arity表示这个Tuple里有几个元素。Tuple2中这个值就是2。接下来对其中每个元素进行序列化。第一个元素为KafkaTopicPartition，这个类对应的序列化器是KryoSerializer类。数据类型、Flink类型系统与序列化器的关系在另外的文章分析。具体的实现非常复杂，大量过程封装在了Kryo框架中，这里不分析。总之serialize方法会将状态数据写入到byte数组中。serialize方法的第一个参数就是状态数据。</p>
<p>回到外层，即callInternal方法中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PartitionableListState</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span>
   <span class="n">registeredOperatorStatesDeepCopies</span><span class="o">.</span><span class="na">entrySet</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>

   <span class="n">PartitionableListState</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="kt">long</span><span class="o">[</span><span class="o">]</span> <span class="n">partitionOffsets</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">localOut</span><span class="o">)</span><span class="o">;</span>
   <span class="n">OperatorStateHandle</span><span class="o">.</span><span class="na">Mode</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">getStateMetaInfo</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">getAssignmentMode</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="n">writtenStatesMetaData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span>
      <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="o">)</span><span class="o">,</span>
      <span class="k">new</span> <span class="n">OperatorStateHandle</span><span class="o">.</span><span class="na">StateMetaInfo</span><span class="o">(</span><span class="n">partitionOffsets</span><span class="o">,</span> <span class="n">mode</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>调用完value.write方法后，获取state的mode。offset的mode为UNION。这个mode涉及到恢复状态数据时的这些数据对于每个并行实例的分配策略，会在另外的文章中单独分析。将partitionsOffsets（即状态数据在文件中的位置）和mode封装在StateMetaInfo中，然后与状态的名称（即entry.getKey）一起放入Map中（writtenStatesMetaData）。</p>
<p>所以说，writtenStatesMeataData中存放了所有状态在文件中的位置，以及状态的mode。最后，callInternal方法执行了如下逻辑：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">StreamStateHandle</span> <span class="n">stateHandle</span> <span class="o">=</span> <span class="n">localOut</span><span class="o">.</span><span class="na">closeAndGetHandle</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

<span class="k">if</span> <span class="o">(</span><span class="n">stateHandle</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">retValue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OperatorStreamStateHandle</span><span class="o">(</span><span class="n">writtenStatesMetaData</span><span class="o">,</span> <span class="n">stateHandle</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">return</span> <span class="n">SnapshotResult</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">retValue</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>先分析localOut.closeAndGetHandle方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">StreamStateHandle</span> <span class="nf">closeAndGetHandle</span><span class="o">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="c1">// check if there was nothing ever written
</span><span class="c1"></span>   <span class="k">if</span> <span class="o">(</span><span class="n">outStream</span> <span class="o">=</span><span class="o">=</span> <span class="kc">null</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">pos</span> <span class="o">=</span><span class="o">=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">closed</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">outStream</span> <span class="o">=</span><span class="o">=</span> <span class="kc">null</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span><span class="o">=</span> <span class="n">localStateThreshold</span><span class="o">)</span> <span class="o">{</span>

           <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
             
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
               <span class="n">flush</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

               <span class="n">pos</span> <span class="o">=</span> <span class="n">writeBuffer</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

               <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="n">1L</span><span class="o">;</span>

               <span class="k">try</span> <span class="o">{</span>
                  <span class="n">size</span> <span class="o">=</span> <span class="n">outStream</span><span class="o">.</span><span class="na">getPos</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
               <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span><span class="o">}</span>

               <span class="n">outStream</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

               <span class="k">return</span> <span class="k">new</span> <span class="n">FileStateHandle</span><span class="o">(</span><span class="n">statePath</span><span class="o">,</span> <span class="n">size</span><span class="o">)</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
               
              <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
                
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
              
               <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
                 
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        
         <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
           
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>关键的逻辑在flush方法中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">flush</span><span class="o">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="o">!</span><span class="n">closed</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// initialize stream if this is the first flush (stream flush, not Darjeeling harvest)
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">outStream</span> <span class="o">=</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">createStream</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// now flush
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">outStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">writeBuffer</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">pos</span><span class="o">)</span><span class="o">;</span>
         <span class="n">pos</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;closed&#34;</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在createStream方法中，先创建了一个输出流，对应了一个文件，文件名是根据一定规则生成的，就是我们在checkpoint目录中看到的文件名为随机字符串的文件。然后调用其write方法将byte数组中的数据写入文件。</p>
<p>flush方法结束后，outStream.getPos获取当前写入的位置，也就是文件的大小，随后将文件路径和文件大小封装成FileStateHandle对象。回到外层方法，又将FileStateHandle对象和writtenStatesMetaData一起封装成OperatorStreamStateHandle对象。最后的返回结果，包含了如下信息：</p>
<p><img src="/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/Checkpoint%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/retValue.png" alt="retValue"></p>
<p>可以看到这个状态被保存在了哪个文件、该文件的大小以及各状态在文件中的位置。</p>
<h2 id="处理文件元信息"><strong>处理文件元信息</strong></h2>
<p>那么这个返回信息被返回并封装到了哪里呢？</p>
<p>回到AbstractStreamOperator的snapshotState方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!</span><span class="o">=</span> <span class="n">operatorStateBackend</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">snapshotInProgress</span><span class="o">.</span><span class="na">setOperatorStateManagedFuture</span><span class="o">(</span>
      <span class="n">operatorStateBackend</span><span class="o">.</span><span class="na">snapshot</span><span class="o">(</span><span class="n">checkpointId</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">factory</span><span class="o">,</span> <span class="n">checkpointOptions</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>外层是调用了operatorStateBackend.snapshot方法才进入到了整个写文件的流程，那么返回的这个对象，就被封装到了snapshotInProgress对象的operatorStateManagedFuture字段中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OperatorSnapshotFutures</span> <span class="o">{</span>

   <span class="nd">@Nonnull</span>
   <span class="kd">private</span> <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">SnapshotResult</span><span class="o">&lt;</span><span class="n">KeyedStateHandle</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">keyedStateManagedFuture</span><span class="o">;</span>

   <span class="nd">@Nonnull</span>
   <span class="kd">private</span> <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">SnapshotResult</span><span class="o">&lt;</span><span class="n">KeyedStateHandle</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">keyedStateRawFuture</span><span class="o">;</span>

   <span class="nd">@Nonnull</span>
   <span class="kd">private</span> <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">SnapshotResult</span><span class="o">&lt;</span><span class="n">OperatorStateHandle</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">operatorStateManagedFuture</span><span class="o">;</span>

   <span class="nd">@Nonnull</span>
   <span class="kd">private</span> <span class="n">RunnableFuture</span><span class="o">&lt;</span><span class="n">SnapshotResult</span><span class="o">&lt;</span><span class="n">OperatorStateHandle</span><span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">operatorStateRawFuture</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>这个类的这几个字段分别保存不同类型的状态。而这个snapshotInProgress对象最终又被AbstractStreamOperator.snapshotState方法返回。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkpointStreamOperator</span><span class="o">(</span><span class="n">StreamOperator</span><span class="o">&lt;</span><span class="o">?</span><span class="o">&gt;</span> <span class="n">op</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!</span><span class="o">=</span> <span class="n">op</span><span class="o">)</span> <span class="o">{</span>

      <span class="n">OperatorSnapshotFutures</span> <span class="n">snapshotInProgress</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="na">snapshotState</span><span class="o">(</span>
            <span class="n">checkpointMetaData</span><span class="o">.</span><span class="na">getCheckpointId</span><span class="o">(</span><span class="o">)</span><span class="o">,</span>
            <span class="n">checkpointMetaData</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="o">)</span><span class="o">,</span>
            <span class="n">checkpointOptions</span><span class="o">,</span>
            <span class="n">storageLocation</span><span class="o">)</span><span class="o">;</span>
      <span class="n">operatorSnapshotsInProgress</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">op</span><span class="o">.</span><span class="na">getOperatorID</span><span class="o">(</span><span class="o">)</span><span class="o">,</span> <span class="n">snapshotInProgress</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这就回到了StreamTask类，被封装进了StreamTask的operatorSnapshotsInProgress字段。这个字段是一个Map。在一个StreamTask中，会有多个算子（Operator），每个算子都会有自己的状态。operatorSnapshotsInProgress字段就维护了算子与其包含的所有状态的关系。</p>
<p>从这里进一步巩固一个知识点。在flink中，算子（Operator）指的就是业务代码中一个map或flatMap等操作，而一个StreamTask中会封装多个算子，这些算子被chain在了一起。所以在对一个StreamTask做checkpoint时，就是对其中每个算子都做了checkpoint。</p>
<p>至此就完成了Task端checkpoint的主要流程。值得注意的是，以上所有操作，都是在一个并行实例中完成的，每个并行实例都是做这样的操作。但写入的过程还没有结束，因为我们还需要将operatorSnapshotsInProgress中保存的信息写入到一个叫做_metadata的文件中，记录下每个算子每个状态在哪个文件、文件的路径以及它们在文件中的位置。</p>
<p>打开checkpoint目录可以看到，每次做checkpoint都会只生成一个_metadata文件，因此可以推测，该过程发生在JobManager端。</p>
<p>回到StreamTask的executeCheckpointing方法中，operatorSnapshotsInProgress字段被封装到了AsyncCheckpointRunnable中。这是一个异步任务。其run方法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="o">)</span> <span class="o">{</span>
  
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
    
   <span class="k">try</span> <span class="o">{</span>

      <span class="n">TaskStateSnapshot</span> <span class="n">jobManagerTaskOperatorSubtaskStates</span> <span class="o">=</span>
         <span class="k">new</span> <span class="n">TaskStateSnapshot</span><span class="o">(</span><span class="n">operatorSnapshotsInProgress</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>

      <span class="n">TaskStateSnapshot</span> <span class="n">localTaskOperatorSubtaskStates</span> <span class="o">=</span>
         <span class="k">new</span> <span class="n">TaskStateSnapshot</span><span class="o">(</span><span class="n">operatorSnapshotsInProgress</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>

      <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">OperatorID</span><span class="o">,</span> <span class="n">OperatorSnapshotFutures</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">operatorSnapshotsInProgress</span><span class="o">.</span><span class="na">entrySet</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>

         <span class="n">OperatorID</span> <span class="n">operatorID</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
         <span class="n">OperatorSnapshotFutures</span> <span class="n">snapshotInProgress</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

         <span class="n">OperatorSnapshotFinalizer</span> <span class="n">finalizedSnapshots</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">OperatorSnapshotFinalizer</span><span class="o">(</span><span class="n">snapshotInProgress</span><span class="o">)</span><span class="o">;</span>

         <span class="n">jobManagerTaskOperatorSubtaskStates</span><span class="o">.</span><span class="na">putSubtaskStateByOperatorID</span><span class="o">(</span>
            <span class="n">operatorID</span><span class="o">,</span>
            <span class="n">finalizedSnapshots</span><span class="o">.</span><span class="na">getJobManagerOwnedState</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>

         <span class="n">localTaskOperatorSubtaskStates</span><span class="o">.</span><span class="na">putSubtaskStateByOperatorID</span><span class="o">(</span>
            <span class="n">operatorID</span><span class="o">,</span>
            <span class="n">finalizedSnapshots</span><span class="o">.</span><span class="na">getTaskLocalState</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
     
     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">asyncCheckpointState</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">CheckpointingOperation</span><span class="o">.</span><span class="na">AsyncCheckpointState</span><span class="o">.</span><span class="na">RUNNING</span><span class="o">,</span>
         <span class="n">CheckpointingOperation</span><span class="o">.</span><span class="na">AsyncCheckpointState</span><span class="o">.</span><span class="na">COMPLETED</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>

         <span class="n">reportCompletedSnapshotStates</span><span class="o">(</span>
            <span class="n">jobManagerTaskOperatorSubtaskStates</span><span class="o">,</span>
            <span class="n">localTaskOperatorSubtaskStates</span><span class="o">,</span>
            <span class="n">asyncDurationMillis</span><span class="o">)</span><span class="o">;</span>

      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        
        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

      <span class="o">}</span>
   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">handleExecutionException</span><span class="o">(</span><span class="n">e</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
     
     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
       
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>operatorSnapshotsInProgress中的信息经过转换，封装进了jobManagerTaskOperatorSubtaskStates中：</p>
<p><img src="/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/Checkpoint%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/jobManagerTaskOperatorSubtaskStates.png" alt="jobManagerTaskOperatorSubtaskStates"></p>
<p>还是同样的信息，维护了每个算子与其包含的所有状态的关系。</p>
<h2 id="jobmanager端的操作"><strong>JobManager端的操作</strong></h2>
<p>接下来调用reportCompletedSnapshotStates方法，将信息发送到JobManager端。调用链为：</p>
<p>StreamTask.reportCompletedSnapshotStates -&gt; TaskStateManagerImpl.reportTaskStateSnapshots -&gt; RpcCheckpointResponder.acknowledgeCheckpoint -&gt; JobMaster.acknowledgeCheckpoint -&gt; LegacyScheduler.acknowledgeCheckpoint。</p>
<p>到这里，文件元信息被封装进了AcknowledgeCheckpoint类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">acknowledgeCheckpoint</span><span class="o">(</span><span class="kd">final</span> <span class="n">JobID</span> <span class="n">jobID</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ExecutionAttemptID</span> <span class="n">executionAttemptID</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">checkpointId</span><span class="o">,</span> <span class="kd">final</span> <span class="n">CheckpointMetrics</span> <span class="n">checkpointMetrics</span><span class="o">,</span> <span class="kd">final</span> <span class="n">TaskStateSnapshot</span> <span class="n">checkpointState</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">mainThreadExecutor</span><span class="o">.</span><span class="na">assertRunningInMainThread</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

   <span class="kd">final</span> <span class="n">CheckpointCoordinator</span> <span class="n">checkpointCoordinator</span> <span class="o">=</span> <span class="n">executionGraph</span><span class="o">.</span><span class="na">getCheckpointCoordinator</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="kd">final</span> <span class="n">AcknowledgeCheckpoint</span> <span class="n">ackMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AcknowledgeCheckpoint</span><span class="o">(</span>
      <span class="n">jobID</span><span class="o">,</span>
      <span class="n">executionAttemptID</span><span class="o">,</span>
      <span class="n">checkpointId</span><span class="o">,</span>
      <span class="n">checkpointMetrics</span><span class="o">,</span>
      <span class="n">checkpointState</span><span class="o">)</span><span class="o">;</span>

   <span class="kd">final</span> <span class="n">String</span> <span class="n">taskManagerLocationInfo</span> <span class="o">=</span> <span class="n">retrieveTaskManagerLocation</span><span class="o">(</span><span class="n">executionAttemptID</span><span class="o">)</span><span class="o">;</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">checkpointCoordinator</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">ioExecutor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="o">(</span><span class="o">)</span> <span class="o">-</span><span class="o">&gt;</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
            <span class="n">checkpointCoordinator</span><span class="o">.</span><span class="na">receiveAcknowledgeMessage</span><span class="o">(</span><span class="n">ackMessage</span><span class="o">,</span> <span class="n">taskManagerLocationInfo</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Error while processing checkpoint acknowledgement message&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span><span class="o">)</span><span class="o">;</span>
   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     
     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
       
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>先从ExecutionGraph中取出CheckpointCoordinator对象。这个对象就是最开始初始化ExecutionGraph时生成的。调用其receiveAcknowledgeMessage方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">receiveAcknowledgeMessage</span><span class="o">(</span><span class="n">AcknowledgeCheckpoint</span> <span class="n">message</span><span class="o">,</span> <span class="n">String</span> <span class="n">taskManagerLocationInfo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CheckpointException</span> <span class="o">{</span>
   
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

   <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
    
    <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

      <span class="c1">// 1.根据checkpointId取出PendingCheckpoint对象。
</span><span class="c1"></span>      <span class="kd">final</span> <span class="n">PendingCheckpoint</span> <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">pendingCheckpoints</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">checkpointId</span><span class="o">)</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">checkpoint</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="o">!</span><span class="n">checkpoint</span><span class="o">.</span><span class="na">isDiscarded</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>

         <span class="c1">// 2.确认收到来自一个Task的checkpoint信息。
</span><span class="c1"></span>         <span class="k">switch</span> <span class="o">(</span><span class="n">checkpoint</span><span class="o">.</span><span class="na">acknowledgeTask</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getTaskExecutionId</span><span class="o">(</span><span class="o">)</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">getSubtaskState</span><span class="o">(</span><span class="o">)</span><span class="o">,</span> <span class="n">message</span><span class="o">.</span><span class="na">getCheckpointMetrics</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">SUCCESS</span><span class="o">:</span>
             
             <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

               <span class="k">if</span> <span class="o">(</span><span class="n">checkpoint</span><span class="o">.</span><span class="na">isFullyAcknowledged</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// 3.如果所有Task都发来了checkpoint信息，则完成最后写_metadata文件等操作。
</span><span class="c1"></span>                  <span class="n">completePendingCheckpoint</span><span class="o">(</span><span class="n">checkpoint</span><span class="o">)</span><span class="o">;</span>
               <span class="o">}</span>
               <span class="k">break</span><span class="o">;</span>
            
             <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
               
         <span class="o">}</span>

         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">checkpoint</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         
        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
          
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        
        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
          
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>step (1) 中的pendingCheckpoints对象是CheckpointCoordinator的一个字段。每一次CheckpointCoordinator触发checkpoint时，都会创建一个PendingCheckpoint对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">PendingCheckpoint</span> <span class="n">checkpoint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PendingCheckpoint</span><span class="o">(</span>
   <span class="n">job</span><span class="o">,</span>
   <span class="n">checkpointID</span><span class="o">,</span>
   <span class="n">timestamp</span><span class="o">,</span>
   <span class="n">ackTasks</span><span class="o">,</span>
   <span class="n">props</span><span class="o">,</span>
   <span class="n">checkpointStorageLocation</span><span class="o">,</span>
   <span class="n">executor</span><span class="o">)</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>然后与checkpointID一起放入pendingCheckpoints这个Map中。在上面的receiveAcknowledgeMessage方法中将其取出，调用其acknowledgeTask方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">TaskAcknowledgeResult</span> <span class="nf">acknowledgeTask</span><span class="o">(</span>
      <span class="n">ExecutionAttemptID</span> <span class="n">executionAttemptId</span><span class="o">,</span>
      <span class="n">TaskStateSnapshot</span> <span class="n">operatorSubtaskStates</span><span class="o">,</span>
      <span class="n">CheckpointMetrics</span> <span class="n">metrics</span><span class="o">)</span> <span class="o">{</span>

   <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
     
     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

      <span class="c1">// 1.根据executionAttemptId获取对应的ExecutionVertex对象。
</span><span class="c1"></span>      <span class="kd">final</span> <span class="n">ExecutionVertex</span> <span class="n">vertex</span> <span class="o">=</span> <span class="n">notYetAcknowledgedTasks</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">executionAttemptId</span><span class="o">)</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">vertex</span> <span class="o">=</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
          
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// 2.在acknowledgedTasks中添加这个executionAttemptId。
</span><span class="c1"></span>         <span class="n">acknowledgedTasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">executionAttemptId</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// 3.从vertex对象中获取这个节点中包含的所有算子ID。
</span><span class="c1"></span>      <span class="n">List</span><span class="o">&lt;</span><span class="n">OperatorID</span><span class="o">&gt;</span> <span class="n">operatorIDs</span> <span class="o">=</span> <span class="n">vertex</span><span class="o">.</span><span class="na">getJobVertex</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">getOperatorIDs</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="c1">// 4.从vertex对象中获取这个并行实例的索引号。
</span><span class="c1"></span>      <span class="kt">int</span> <span class="n">subtaskIndex</span> <span class="o">=</span> <span class="n">vertex</span><span class="o">.</span><span class="na">getParallelSubtaskIndex</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="kt">long</span> <span class="n">ackTimestamp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>

      <span class="kt">long</span> <span class="n">stateSize</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">operatorSubtaskStates</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// 5.遍历每一个算子。
</span><span class="c1"></span>         <span class="k">for</span> <span class="o">(</span><span class="n">OperatorID</span> <span class="n">operatorID</span> <span class="o">:</span> <span class="n">operatorIDs</span><span class="o">)</span> <span class="o">{</span>

            <span class="c1">// 6.根据算子ID取出该算子的文件元信息。
</span><span class="c1"></span>            <span class="n">OperatorSubtaskState</span> <span class="n">operatorSubtaskState</span> <span class="o">=</span>
               <span class="n">operatorSubtaskStates</span><span class="o">.</span><span class="na">getSubtaskStateByOperatorID</span><span class="o">(</span><span class="n">operatorID</span><span class="o">)</span><span class="o">;</span>
           
           <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

            <span class="c1">// 7.从operatorStates中，根据算子ID取出一个OperatorState对象。
</span><span class="c1"></span>            <span class="n">OperatorState</span> <span class="n">operatorState</span> <span class="o">=</span> <span class="n">operatorStates</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">operatorID</span><span class="o">)</span><span class="o">;</span>

            
            <span class="k">if</span> <span class="o">(</span><span class="n">operatorState</span> <span class="o">=</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">operatorState</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OperatorState</span><span class="o">(</span>
                  <span class="n">operatorID</span><span class="o">,</span>
                  <span class="n">vertex</span><span class="o">.</span><span class="na">getTotalNumberOfParallelSubtasks</span><span class="o">(</span><span class="o">)</span><span class="o">,</span>
                  <span class="n">vertex</span><span class="o">.</span><span class="na">getMaxParallelism</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
               <span class="n">operatorStates</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">operatorID</span><span class="o">,</span> <span class="n">operatorState</span><span class="o">)</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// 8.以并行实例索引号为key，OperatorSubtaskState对象为value，建立对应关系。
</span><span class="c1"></span>            <span class="n">operatorState</span><span class="o">.</span><span class="na">putState</span><span class="o">(</span><span class="n">subtaskIndex</span><span class="o">,</span> <span class="n">operatorSubtaskState</span><span class="o">)</span><span class="o">;</span>
            <span class="n">stateSize</span> <span class="o">+</span><span class="o">=</span> <span class="n">operatorSubtaskState</span><span class="o">.</span><span class="na">getStateSize</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span>

      <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

      <span class="k">return</span> <span class="n">TaskAcknowledgeResult</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个方法所做的事情，就是JobManager端确认收到了每个Task（即每个ExecutionVertex，一个ExecutionVertex表示一个并行实例）发来的checkpoint信息。这个方法很重要，这里逐步分析上面的步骤。</p>
<p>step (1) 中的notYetAcknowledgedTasks字段，就是最初构建PendingCheckpoint时传入的第四个参数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">PendingCheckpoint</span><span class="o">(</span>
      <span class="n">JobID</span> <span class="n">jobId</span><span class="o">,</span>
      <span class="kt">long</span> <span class="n">checkpointId</span><span class="o">,</span>
      <span class="kt">long</span> <span class="n">checkpointTimestamp</span><span class="o">,</span>
      <span class="n">Map</span><span class="o">&lt;</span><span class="n">ExecutionAttemptID</span><span class="o">,</span> <span class="n">ExecutionVertex</span><span class="o">&gt;</span> <span class="n">verticesToConfirm</span><span class="o">,</span>
      <span class="n">CheckpointProperties</span> <span class="n">props</span><span class="o">,</span>
      <span class="n">CheckpointStorageLocation</span> <span class="n">targetLocation</span><span class="o">,</span>
      <span class="n">Executor</span> <span class="n">executor</span><span class="o">)</span> <span class="o">{</span>

   <span class="n">checkArgument</span><span class="o">(</span><span class="n">verticesToConfirm</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">,</span>
         <span class="s">&#34;Checkpoint needs at least one vertex that commits the checkpoint&#34;</span><span class="o">)</span><span class="o">;</span>

   <span class="k">this</span><span class="o">.</span><span class="na">jobId</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">jobId</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">checkpointId</span> <span class="o">=</span> <span class="n">checkpointId</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">checkpointTimestamp</span> <span class="o">=</span> <span class="n">checkpointTimestamp</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">notYetAcknowledgedTasks</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">verticesToConfirm</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">props</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">props</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">targetLocation</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">targetLocation</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">executor</span> <span class="o">=</span> <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">executor</span><span class="o">)</span><span class="o">;</span>

   <span class="k">this</span><span class="o">.</span><span class="na">operatorStates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">masterState</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">acknowledgedTasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="n">verticesToConfirm</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">onCompletionPromise</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="o">&gt;</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个参数的值也是在初始化过程中设置好的，包含每个ExecutionVertex与其对应的一个ID的映射关系。这个ID也传到了Task端，在确认checkpoint的阶段时又回传到了JobManager端。因此可以根据这个ID取出ExecutionVertex对象。</p>
<p>step (2) 将这个ID添加进了acknowledgedTasks字段。这个字段对主逻辑没有什么用，是为了代码健壮性存在的。</p>
<p>step (3) 获取这个vertex包含的所有算子的ID。</p>
<p>step (4) 获取这个vertex的并行实例的索引号。这是一步非常重要的操作。因为目前为止，我们只知道这个并行实例中每个算子与其状态的对应信息，如下：</p>
<p><img src="/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/Checkpoint%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/operatorSubtaskStates.png" alt="operatorSubtaskStates"></p>
<p>但是还不知道这些信息属于哪个并行实例。因此还需要一个对象来保存并行实例的索引号与算子、文件元信息的对应关系。</p>
<p>step (5) 开始对每个算子进行遍历。首先从operatorSubtaskStates对象中根据算子ID取出那个算子的文件元信息，然后将并行实例索引号与该信息一起封装进了OperatorState对象中（operatorState.putState方法）。其实就是放进了该类的这个字段中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">OperatorSubtaskState</span><span class="o">&gt;</span> <span class="n">operatorSubtaskStates</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>而这个OperatorState对象，是通过 step (7) 得到的。operatorStates字段是PendingCheckpoint的一个字段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">OperatorID</span><span class="o">,</span> <span class="n">OperatorState</span><span class="o">&gt;</span> <span class="n">operatorStates</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>通过对上面两个字段的分析，可以知道，一个OperatorState对象就对应了一个算子。而在该算子内部，维护了这个算子在每个并行实例上的文件元信息。</p>
<p><img src="/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/Checkpoint%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B/operatorState.png" alt="operatorState"></p>
<p>因为代码中设置的并行度为1，所以operatorSubtaskStates字段里只有key为0的一个索引号。managedOperatorState就是之前获得的文件元信息。</p>
<p>上面的方法结束后，回到CheckpointCoordinator.receiveAcknowledgeMessage方法中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">checkpoint</span><span class="o">.</span><span class="na">isFullyAcknowledged</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">completePendingCheckpoint</span><span class="o">(</span><span class="n">checkpoint</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>先判断是否接收到了所有并行实例发送回来的checkpoint确认信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFullyAcknowledged</span><span class="o">(</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">notYetAcknowledgedTasks</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="o">)</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="o">!</span><span class="n">discarded</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果全部接收，就出发最后的completePendingCheckpoint操作。</p>
<p>在官方文档的介绍中，可以了解到flink在做checkpoint时，是从JobManager端触发，每个并行实例单独做checkpoint的操作，做完后需要给JobManager端确认该并行实例完成了checkpoint，当所有并行实例都做完了checkpoint，JobManager端会做一些收尾工作，完成整个checkpoint的流程。我们已经从源码上证明了这一流程的确是这样。</p>
<p>最后来分析completePendingCheckpoint方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">completePendingCheckpoint</span><span class="o">(</span><span class="n">PendingCheckpoint</span> <span class="n">pendingCheckpoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CheckpointException</span> <span class="o">{</span>
   <span class="kd">final</span> <span class="kt">long</span> <span class="n">checkpointId</span> <span class="o">=</span> <span class="n">pendingCheckpoint</span><span class="o">.</span><span class="na">getCheckpointId</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
   <span class="kd">final</span> <span class="n">CompletedCheckpoint</span> <span class="n">completedCheckpoint</span><span class="o">;</span>

   <span class="c1">// As a first step to complete the checkpoint, we register its state with the registry
</span><span class="c1"></span>   <span class="n">Map</span><span class="o">&lt;</span><span class="n">OperatorID</span><span class="o">,</span> <span class="n">OperatorState</span><span class="o">&gt;</span> <span class="n">operatorStates</span> <span class="o">=</span> <span class="n">pendingCheckpoint</span><span class="o">.</span><span class="na">getOperatorStates</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
  
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

   <span class="k">try</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="c1">// 1.写_metadata文件。
</span><span class="c1"></span>         <span class="n">completedCheckpoint</span> <span class="o">=</span> <span class="n">pendingCheckpoint</span><span class="o">.</span><span class="na">finalizeCheckpoint</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
        
        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
          
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
          
      <span class="o">}</span>

     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

   <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
     
     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
       
   <span class="o">}</span>
  
  <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

   <span class="k">for</span> <span class="o">(</span><span class="n">ExecutionVertex</span> <span class="n">ev</span> <span class="o">:</span> <span class="n">tasksToCommitTo</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Execution</span> <span class="n">ee</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getCurrentExecutionAttempt</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ee</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// 2.通知checkpoint完成。
</span><span class="c1"></span>         <span class="n">ee</span><span class="o">.</span><span class="na">notifyCheckpointComplete</span><span class="o">(</span><span class="n">checkpointId</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">)</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>主要的事情就是两件，第一件是创建_metadata文件并写入，第二件是触发notifyCheckpointComplete操作。notifyCheckpointComplete方法其实在分析FlinkKafkaConsumer如何维护和恢复offset时已经见过，它会触发算子的notifyCheckpointComplete操作。</p>
<p>分析pendingCheckpoint.finalizeCheckpoint方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">CompletedCheckpoint</span> <span class="nf">finalizeCheckpoint</span><span class="o">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

   <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
      
     <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

      <span class="k">try</span> <span class="o">{</span>
         <span class="kd">final</span> <span class="n">Savepoint</span> <span class="n">savepoint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SavepointV2</span><span class="o">(</span><span class="n">checkpointId</span><span class="o">,</span> <span class="n">operatorStates</span><span class="o">.</span><span class="na">values</span><span class="o">(</span><span class="o">)</span><span class="o">,</span> <span class="n">masterState</span><span class="o">)</span><span class="o">;</span>
         <span class="kd">final</span> <span class="n">CompletedCheckpointStorageLocation</span> <span class="n">finalizedLocation</span><span class="o">;</span>

         <span class="k">try</span> <span class="o">(</span><span class="n">CheckpointMetadataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">targetLocation</span><span class="o">.</span><span class="na">createMetadataOutputStream</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Checkpoints</span><span class="o">.</span><span class="na">storeCheckpointMetadata</span><span class="o">(</span><span class="n">savepoint</span><span class="o">,</span> <span class="n">out</span><span class="o">)</span><span class="o">;</span>
            <span class="n">finalizedLocation</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">closeAndFinalizeCheckpoint</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
         <span class="o">}</span>

         <span class="n">CompletedCheckpoint</span> <span class="n">completed</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CompletedCheckpoint</span><span class="o">(</span>
               <span class="n">jobId</span><span class="o">,</span>
               <span class="n">checkpointId</span><span class="o">,</span>
               <span class="n">checkpointTimestamp</span><span class="o">,</span>
               <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(</span><span class="o">)</span><span class="o">,</span>
               <span class="n">operatorStates</span><span class="o">,</span>
               <span class="n">masterState</span><span class="o">,</span>
               <span class="n">props</span><span class="o">,</span>
               <span class="n">finalizedLocation</span><span class="o">)</span><span class="o">;</span>

        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>

         <span class="k">return</span> <span class="n">completed</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">.</span>
          
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>将checkpointId、状态信息（即上面那个每个算子与各个并行实例中的状态的映射关系）等封装进Savepoint对象中。写文件的逻辑在Checkpoints.storeCheckpointMetadata中执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">Savepoint</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">storeCheckpointMetadata</span><span class="o">(</span>
      <span class="n">T</span> <span class="n">checkpointMetadata</span><span class="o">,</span>
      <span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

   <span class="n">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">)</span><span class="o">;</span>
   <span class="n">storeCheckpointMetadata</span><span class="o">(</span><span class="n">checkpointMetadata</span><span class="o">,</span> <span class="n">dos</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">Savepoint</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">storeCheckpointMetadata</span><span class="o">(</span>
      <span class="n">T</span> <span class="n">checkpointMetadata</span><span class="o">,</span>
      <span class="n">DataOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

   <span class="c1">// write generic header
</span><span class="c1"></span>   <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">HEADER_MAGIC_NUMBER</span><span class="o">)</span><span class="o">;</span>
   <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">checkpointMetadata</span><span class="o">.</span><span class="na">getVersion</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">;</span>

   <span class="c1">// write checkpoint metadata
</span><span class="c1"></span>   <span class="n">SavepointSerializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">SavepointSerializers</span><span class="o">.</span><span class="na">getSerializer</span><span class="o">(</span><span class="n">checkpointMetadata</span><span class="o">)</span><span class="o">;</span>
   <span class="n">serializer</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">checkpointMetadata</span><span class="o">,</span> <span class="n">out</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>用4个字节记录HEADER_MAGIC_NUMBER，用4个字节记录版本信息。获取序列化器。_metadata文件的序列化器是SavepointV2Serializer。序列化方法不细分析，这里给出格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">*  +--------------+---------------+-----------------+
*  | checkpointID | master states | operator states |
*  +--------------+---------------+-----------------+
</code></pre></td></tr></table>
</div>
</div><h2 id="总结"><strong>总结</strong></h2>
<p>checkpoint文件的写入流程从Task端开始，每个并行实例独自写自己的状态数据。这部分数据包含这个Task中每个算子每个状态的序列化器等信息（本文称为“<strong>状态元信息</strong>”）和状态数据。写完状态数据文件后，Task端会有一个对象保存了文件路径、文件大小、每个状态在文件中的位置等信息（本文称为“<strong>文件元信息</strong>”），这个对象会发送给JobManager端。JobManager端会将并行实例与文件元信息关系对应起来，这样就知道了每个算子的每个并行实例中该算子的状态信息。JobManager端等所有并行实例都完成了chekcpoint操作后，会将文件元信息写入到_metadata文件中，并且会触发notifyCheckpointComplete操作。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Weizhe Huang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-03-18
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/%E6%B7%B1%E5%85%A5flink%E6%BA%90%E7%A0%81-checkpoint%E7%8A%B6%E6%80%81%E6%81%A2%E5%A4%8D%E6%B5%81%E7%A8%8B/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">深入Flink源码 - Checkpoint状态恢复流程</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/%E6%B7%B1%E5%85%A5flink%E6%BA%90%E7%A0%81-flinkkafkaconsumer%E5%A6%82%E4%BD%95%E7%BB%B4%E6%8A%A4%E5%92%8C%E6%81%A2%E5%A4%8Doffset/">
            <span class="next-text nav-default">深入Flink源码 - FlinkKafkaConsumer如何维护和恢复offset</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="http://localhost:1313" class="iconfont icon-twitter" title="twitter"></a>
      <a href="http://localhost:1313" class="iconfont icon-facebook" title="facebook"></a>
      <a href="http://localhost:1313" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-pocket" title="pocket"></a>
      <a href="http://localhost:1313" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
      <a href="http://localhost:1313" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="http://localhost:1313" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Weizhe Huang</span>
  </span>
</div>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]} })
</script>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
